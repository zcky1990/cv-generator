<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CV - Nabhel Template</title>
        <!-- Google Fonts: Inter and DM Sans -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            // Suppress Tailwind CDN production warning - CDN is appropriate for this standalone application
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, args);
            };
            
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        borderRadius: {
                            lg: 'var(--radius)',
                            md: 'calc(var(--radius) - 2px)',
                            sm: 'calc(var(--radius) - 4px)'
                        }
                    }
                }
            }
        </script>
        <!-- html2pdf library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <style>
            /* Base font for entire document - Inter and DM Sans */
            body {
                font-family: 'Inter', 'DM Sans', 'Arial', sans-serif;
            }
            
            #cvContainer, #cvContainer * {
                font-family: 'DM Sans', 'Inter', 'Arial', sans-serif !important;
            }
            
            /* Ensure buttons have proper font */
            button {
                font-family: 'Inter', 'Arial', sans-serif !important;
            }
            
            :root {
                --radius: 0.65rem;
                --background: 0 0% 100%;
                --foreground: 0 0% 3.9%;
                --card: 0 0% 100%;
                --card-foreground: 0 0% 3.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 0 0% 3.9%;
                --primary: 0 0% 9%;
                --primary-foreground: 0 0% 98%;
                --secondary: 0 0% 96.1%;
                --secondary-foreground: 0 0% 9%;
                --muted: 0 0% 96.1%;
                --muted-foreground: 0 0% 45.1%;
                --accent: 0 0% 96.1%;
                --accent-foreground: 0 0% 9%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 0 0% 98%;
                --border: 0 0% 89.8%;
                --input: 0 0% 89.8%;
                --ring: 0 0% 3.9%;
                --chart-1: 12 76% 61%;
                --chart-2: 173 58% 39%;
                --chart-3: 197 37% 24%;
                --chart-4: 43 74% 66%;
                --chart-5: 27 87% 67%;
            }

            .dark {
                --background: 0 0% 3.9%;
                --foreground: 0 0% 98%;
                --card: 0 0% 9%;
                --card-foreground: 0 0% 98%;
                --popover: 0 0% 9%;
                --popover-foreground: 0 0% 98%;
                --primary: 0 0% 89.8%;
                --primary-foreground: 0 0% 9%;
                --secondary: 0 0% 14.9%;
                --secondary-foreground: 0 0% 98%;
                --muted: 0 0% 14.9%;
                --muted-foreground: 0 0% 63.9%;
                --accent: 0 0% 14.9%;
                --accent-foreground: 0 0% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 0 0% 98%;
                --border: 0 0% 100% / 0.1;
                --input: 0 0% 100% / 0.15;
                --ring: 0 0% 45.1%;
                --chart-1: 220 70% 50%;
                --chart-2: 160 60% 45%;
                --chart-3: 30 80% 55%;
                --chart-4: 280 65% 60%;
                --chart-5: 340 75% 55%;
                --sidebar: 0 0% 9%;
                --sidebar-foreground: 0 0% 98%;
                --sidebar-primary: 220 70% 50%;
                --sidebar-primary-foreground: 0 0% 98%;
                --sidebar-accent: 0 0% 14.9%;
                --sidebar-accent-foreground: 0 0% 98%;
                --sidebar-border: 0 0% 100% / 0.1;
                --sidebar-ring: 0 0% 45.1%;
            }

            /* shadcn/ui color utilities for Tailwind v3 */
            .bg-background { background-color: hsl(var(--background)); }
            .bg-card { background-color: hsl(var(--card)); }
            .bg-popover { background-color: hsl(var(--popover)); }
            .bg-primary { background-color: hsl(var(--primary)); }
            .bg-secondary { background-color: hsl(var(--secondary)); }
            .bg-muted { background-color: hsl(var(--muted)); }
            .bg-accent { background-color: hsl(var(--accent)); }
            .bg-destructive { background-color: hsl(var(--destructive)); }
            .text-foreground { color: hsl(var(--foreground)); }
            .text-card-foreground { color: hsl(var(--card-foreground)); }
            .text-popover-foreground { color: hsl(var(--popover-foreground)); }
            .text-primary { color: hsl(var(--primary)); }
            .text-primary-foreground { color: hsl(var(--primary-foreground)); }
            .text-secondary-foreground { color: hsl(var(--secondary-foreground)); }
            .text-muted-foreground { color: hsl(var(--muted-foreground)); }
            .text-accent-foreground { color: hsl(var(--accent-foreground)); }
            .text-destructive-foreground { color: hsl(var(--destructive-foreground)); }
            .border-border { border-color: hsl(var(--border)); }
            .border-input { border-color: hsl(var(--input)); }
            .border-ring { border-color: hsl(var(--ring)); }
            
            /* Opacity variants */
            .bg-primary\/90 { background-color: hsl(var(--primary) / 0.9); }
            .bg-secondary\/80 { background-color: hsl(var(--secondary) / 0.8); }
            .bg-muted\/50 { background-color: hsl(var(--muted) / 0.5); }
            .bg-accent\/50 { background-color: hsl(var(--accent) / 0.5); }
            .bg-destructive\/90 { background-color: hsl(var(--destructive) / 0.9); }
            
            .hover\:bg-primary\/90:hover { background-color: hsl(var(--primary) / 0.9); }
            .hover\:bg-secondary\/80:hover { background-color: hsl(var(--secondary) / 0.8); }
            
            /* Ensure buttons have visible text and proper font */
            button {
                font-family: 'Inter', 'Arial', sans-serif !important;
            }
            
            button.bg-primary,
            button.bg-primary * {
                color: hsl(var(--primary-foreground)) !important;
            }
            
            button.bg-secondary,
            button.bg-secondary * {
                color: hsl(var(--secondary-foreground)) !important;
            }
            
            /* Ensure text in buttons is visible */
            .text-primary-foreground {
                color: hsl(var(--primary-foreground)) !important;
            }
            
            .text-secondary-foreground {
                color: hsl(var(--secondary-foreground)) !important;
            }

            /* Nabhel Template Specific Styles */
            
            .nabhel-section-header {
                font-family: 'Inter', 'Arial', sans-serif;
                font-weight: 700;
                font-size: 14px;
                color: #2E2E48;
                margin-bottom: 16px;
            }
            
            .nabhel-divider {
                border-top: 0.5px solid #E2E6EE;
                width: 119px;
                margin: 10px 0;
            }
            
            /* Page break handling for print */
            @media print {
                #cvContainer {
                    background: white !important;
                    color: black !important;
                }
                
                .nabhel-section {
                    page-break-inside: avoid;
                    break-inside: avoid;
                    margin-bottom: 12px;
                }
                
                .nabhel-section-header {
                    page-break-after: avoid;
                    break-after: avoid;
                    margin-bottom: 8px;
                }
                
                .nabhel-entry {
                    page-break-inside: avoid;
                    break-inside: avoid;
                    margin-bottom: 12px;
                }
                
                /* Prevent orphaned headers */
                .nabhel-section-header + * {
                    page-break-before: avoid;
                    break-before: avoid;
                }
                
                /* Ensure table layout works in print */
                #cvContainer [style*="display: table"] {
                    display: table !important;
                }
                
                #cvContainer [style*="display: table-cell"] {
                    display: table-cell !important;
                }
            }
            
            /* Drawer styles */
            .drawer-closed {
                width: 0px;
            }
            .drawer-open {
                width: 280px;
            }
            .drawer-item-icon {
                transition: all 0.2s ease;
            }
            .drawer-item.active {
                background-color: hsl(var(--primary));
                color: hsl(var(--primary-foreground));
            }
            .drawer-item.active .drawer-item-icon {
                color: hsl(var(--primary-foreground));
            }
            .drawer-item.active .drawer-item-content {
                color: hsl(var(--primary-foreground));
            }
            .drawer-item.active .drawer-item-content .text-muted-foreground {
                color: hsl(var(--primary-foreground) / 0.8);
            }
            
            /* Drawer toggle button transitions */
            #drawerToggle {
                transition: all 0.3s ease-in-out;
            }
            #drawerToggleIcon {
                transition: all 0.3s ease-in-out;
            }
            #drawerToggleText {
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            }
            
            /* Improved print styles */
            @media print {
                body {
                    background: white !important;
                }
                
                #cvContainer {
                    box-shadow: none !important;
                    width: var(--print-width, 215.9mm) !important;
                    min-width: var(--print-width, 215.9mm) !important;
                    max-width: var(--print-width, 215.9mm) !important;
                    min-height: var(--print-height, 279.4mm) !important;
                }
                
                /* Better text rendering for print */
                #cvContainer * {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
            }
        </style>
    </head>
    <body class="bg-background text-foreground min-h-screen print:bg-white print:p-0 print:m-0">
        <!-- Left Drawer -->
        <div id="leftDrawer" class="fixed left-0 top-0 h-full bg-card border-r border-border shadow-xl/30 z-40 transition-all duration-300 ease-in-out drawer-closed print:hidden">
            <!-- Drawer Toggle Button -->
            <button id="drawerToggle" onclick="toggleDrawer()" class="flex flex-col gap-2 absolute top-1/2 -translate-y-1/2 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border border-border rounded-lg shadow-lg p-4 print:hidden items-center justify-center" style="width: 120px; height: 120px; right: -145px; transition: all 0.3s ease-in-out;">
                <p id="drawerToggleText" class="text-sm text-muted-foreground text-center" style="opacity: 1; transform: scale(1); transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;">Treat Me Coffee</p>
                <svg id="drawerToggleIcon" class="text-foreground" style="width: 50px; height: 50px; transition: all 0.3s ease-in-out;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.121 18.121" xml:space="preserve"><path style="fill:#e4e7e7" d="m15.292 3.397-1.717 14.724H4.548L2.829 3.397z"/><path style="fill:#c8cbcb" d="m4.417 16.992.132 1.129h9.026l.131-1.129zM2.896 3.964l1.351 11.569L15.217 4.04l.01-.076z"/><path style="fill:#349886" d="M9.061 6.795a3.399 3.399 0 1 0 .002 6.798 3.399 3.399 0 0 0-.002-6.798m1.678 4.907c-.302-.167-.701-.289-1.152-.344l.023-.181a1.128 1.128 0 0 0-.549-2.118c-.625 0-1.133.507-1.133 1.133 0 .425.237.791.584.984l.024.181c-.452.056-.851.177-1.152.344a2.25 2.25 0 0 1-.588-1.509 2.265 2.265 0 1 1 4.53 0c0 .583-.225 1.108-.587 1.51"/><path style="fill:#2b414d" d="M2.832 1.699H15.29c.626 0 1.133.507 1.133 1.133v1.133H1.699V2.831c0-.626.507-1.133 1.133-1.133"/><path style="fill:#475f6c" d="M4.53 0h9.061c.626 0 1.133.507 1.133 1.133v.566H3.398v-.566C3.398.507 3.905 0 4.53 0"/><path style="fill:#2e8676" d="M9.061 9.061c-.625 0-1.133.507-1.133 1.133 0 .397.211.736.52.938l1.528-1.6a1.13 1.13 0 0 0-.916-.47m0-2.265a3.399 3.399 0 0 0-2.193 5.992l1.303-1.365a2.9 2.9 0 0 0-.788.281 2.25 2.25 0 0 1-.588-1.51A2.265 2.265 0 0 1 9.059 7.93c.681 0 1.284.306 1.699.781l.788-.826a3.38 3.38 0 0 0-2.487-1.089"/></svg>
            </button>
            
            <!-- Drawer Content -->
            <div class="h-full flex flex-col py-4 overflow-hidden">
                <!-- Drawer Items Container -->
                <div class="flex-1 flex flex-col items-center justify-center gap-4 px-4">
                    <!-- Title -->
                    <h2 class="text-xl font-bold text-foreground text-center">Treat me coffee</h2>
                    
                    <!-- Image -->
                    <div class="flex justify-center cursor-pointer" onclick="openImageModal()">
                        <img src="../images/G700863694-0703A01-default.png" alt="Coffee" class="max-w-full h-auto rounded-lg shadow-md hover:opacity-80 transition-opacity">
                    </div>
                    
                    <!-- Thanks -->
                    <p class="text-sm text-muted-foreground text-center">Thanks</p>
                </div>
            </div>
        </div>
        
        <!-- Image Modal -->
        <div id="imageModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center print:hidden" onclick="closeImageModal(event)">
            <div class="relative max-w-4xl max-h-[90vh] mx-4" onclick="event.stopPropagation()">
                <!-- Close Button -->
                <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <!-- Image -->
                <img src="../images/G700863694-0703A01-default.png" alt="Coffee" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">
            </div>
        </div>
        
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-4 md:p-6 print:p-0 print:m-0 print:bg-white transition-all duration-300" id="mainContent">
            <div class="max-w-4xl mx-auto bg-card rounded-lg shadow-sm print:max-w-none print:shadow-none print:rounded-none print:m-0">
                <!-- Fixed Page Options Menu on Right -->
                <div class="fixed top-1/2 right-4 -translate-y-1/2 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border border-border rounded-lg shadow-lg p-4 print:hidden">
                    <div class="text-xs font-semibold text-muted-foreground mb-3">Page Options</div>
                    <div class="space-y-3">
                        <table class="text-xs text-muted-foreground">
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Paper Size:</td>
                                <td class="py-1">
                                    <select id="paperSize" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm" onchange="updatePaperSize(this.value)">
                                        <option value="letter">Letter</option>
                                        <option value="a4">A4</option>
                                        <option value="legal">Legal</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Orientation:</td>
                                <td class="py-1">
                                    <select id="orientation" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm" onchange="updateOrientation(this.value)">
                                        <option value="portrait">Portrait</option>
                                        <option value="landscape">Landscape</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Top (mm):</td>
                                <td class="py-1">
                                    <input type="number" id="topMargin" min="0" max="20" step="1" value="12" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm text-center" onchange="updateMargin('top', this.value)" oninput="updateMargin('top', this.value)">
                                </td>
                            </tr>
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Bottom (mm):</td>
                                <td class="py-1">
                                    <input type="number" id="bottomMargin" min="0" max="20" step="1" value="12" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm text-center" onchange="updateMargin('bottom', this.value)" oninput="updateMargin('bottom', this.value)">
                                </td>
                            </tr>
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Right (mm):</td>
                                <td class="py-1">
                                    <input type="number" id="rightMargin" min="0" max="20" step="1" value="5" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm text-center" onchange="updateMargin('right', this.value)" oninput="updateMargin('right', this.value)">
                                </td>
                            </tr>
                            <tr>
                                <td class="pr-2 py-1 whitespace-nowrap">Left (mm):</td>
                                <td class="py-1">
                                    <input type="number" id="leftMargin" min="0" max="20" step="1" value="5" class="w-full h-9 rounded-md border border-input bg-background px-2 py-1 text-sm text-center" onchange="updateMargin('left', this.value)" oninput="updateMargin('left', this.value)">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Fixed Action Buttons at Top -->
                <div class="sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border print:hidden">
                    <div class="p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl md:text-2xl font-bold tracking-tight">Your CV Preview</h1>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                                <button onclick="downloadPDF(event)" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-primary text-primary-foreground hover:bg-primary/90 h-9 rounded-md gap-1.5 px-4 shadow-sm border-0 cursor-pointer flex-1 sm:flex-none">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download PDF
                                </button>
                                <button onclick="goBack()" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 rounded-md gap-1.5 px-4 shadow-sm border-0 cursor-pointer flex-1 sm:flex-none">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                    Back to Edit
                                </button>
                                <button id="themeToggle" type="button" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 w-9 rounded-md shadow-sm border-0 cursor-pointer" aria-label="Toggle theme" title="Toggle light/dark theme">
                                    <svg id="sunIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    <svg id="moonIcon" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CV Content -->
                <div class="flex justify-center items-start px-4 print:p-0 print:m-0">
                    <div id="cvContainer" class="bg-card text-foreground rounded-lg shadow-lg print:shadow-none print:rounded-none print:p-0 print:m-0 print:bg-white print:w-[612px] print:max-w-[612px] print:min-h-[792px] print:text-black print:mx-auto" style="margin: 0 auto; padding: 28px; max-width: 100%; box-sizing: border-box;">
                        <div id="loadingMessage" class="text-center py-8">
                            <p class="text-muted-foreground">Loading CV...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../script.js"></script>
        <script>
            // Load and generate CV from localStorage
            function loadAndGenerateCV() {
                const loadingMessage = document.getElementById('loadingMessage');
                const cvContainer = document.getElementById('cvContainer');
                
                try {
                    const cvData = localStorage.getItem('cvData');
                    if (!cvData) {
                        loadingMessage.innerHTML = '<p class="text-destructive">No CV data found. Please go back and fill out the form.</p>';
                        return;
                    }
                    
                    const data = JSON.parse(cvData);
                    const html = generateCVFromData(data);
                    
                    cvContainer.innerHTML = html;
                    loadingMessage.style.display = 'none';
                    
                    // Load and apply page settings
                    loadPageSettings();
                    
                    // Ensure page settings are applied after content is rendered
                    setTimeout(() => {
                        applyPageSettings();
                    }, 50);
                } catch (error) {
                    console.error('Error loading CV:', error);
                    loadingMessage.innerHTML = '<p class="text-destructive">Error loading CV: ' + error.message + '</p>';
                }
            }

            // Download PDF
            async function downloadPDF(event) {
                if (event) event.preventDefault();
                
                const cvContainer = document.getElementById('cvContainer');
                if (!cvContainer) {
                    alert('CV container not found');
                    return;
                }

                // Get the name from localStorage data for filename
                let filename = 'cv.pdf';
                try {
                    const cvDataJson = localStorage.getItem('cvData');
                    if (cvDataJson) {
                        const data = JSON.parse(cvDataJson);
                        if (data.name) {
                            filename = data.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_cv.pdf';
                        }
                    }
                } catch (e) {
                    console.warn('Could not get name from localStorage:', e);
                }

                // Get page settings from localStorage or use defaults
                let margin = [12, 5, 12, 5]; // default: [top, right, bottom, left] - range 0-20
                let paperSize = 'letter';
                let orientation = 'portrait';
                try {
                    const cvDataJson = localStorage.getItem('cvData');
                    if (cvDataJson) {
                        const data = JSON.parse(cvDataJson);
                        if (data.margin && Array.isArray(data.margin) && data.margin.length === 4) {
                            // Ensure all margins are between 0 and 20
                            margin = [
                                Math.max(0, Math.min(20, parseFloat(data.margin[0]) || 12)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[1]) || 5)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[2]) || 12)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[3]) || 5))
                            ];
                        }
                        if (data.paperSize) {
                            paperSize = data.paperSize;
                        }
                        if (data.orientation) {
                            orientation = data.orientation;
                        }
                    }
                } catch (e) {
                    console.warn('Could not get page settings from localStorage, using defaults:', e);
                }

                // Configure html2pdf options
                const options = {
                    margin: margin,
                    filename: filename,
                    image: {
                        type: 'jpeg',
                        quality: 0.98
                    },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: paperSize,
                        orientation: orientation,
                        compress: true
                    },
                    pagebreak: {
                        mode: ['css', 'legacy'],
                        avoid: ['.nabhel-section', '.nabhel-entry', '.nabhel-section-header'],
                    }
                };

                // Get button reference
                const button = event ? event.target.closest('button') : document.querySelector('button[onclick*="downloadPDF"]');
                const originalText = button ? button.innerHTML : '';

                try {
                    // Scroll to top before generating PDF
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    
                    // Show loading state
                    if (button) {
                        button.disabled = true;
                        button.innerHTML = '<span>⏳</span> Generating PDF...';
                    }
                    
                    // Wait a moment for scroll to complete
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // Generate PDF - pass HTML as is, no modifications
                    await html2pdf().set(options).from(cvContainer).save();

                    // Reset button state
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                    
                    // Reset button state on error
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                }
            }

            // Go back to edit page
            function goBack() {
                window.location.replace('../index.html');
            }

            // Theme toggle
            function toggleTheme() {
                const html = document.documentElement;
                const isDark = html.classList.contains('dark');
                const sunIcon = document.getElementById('sunIcon');
                const moonIcon = document.getElementById('moonIcon');
                
                if (isDark) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    if (sunIcon) sunIcon.classList.remove('hidden');
                    if (moonIcon) moonIcon.classList.add('hidden');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    if (sunIcon) sunIcon.classList.add('hidden');
                    if (moonIcon) moonIcon.classList.remove('hidden');
                }
            }

            // Initialize theme on load
            document.addEventListener('DOMContentLoaded', function() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                const sunIcon = document.getElementById('sunIcon');
                const moonIcon = document.getElementById('moonIcon');
                
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    if (sunIcon) sunIcon.classList.add('hidden');
                    if (moonIcon) moonIcon.classList.remove('hidden');
                } else {
                    if (sunIcon) sunIcon.classList.remove('hidden');
                    if (moonIcon) moonIcon.classList.add('hidden');
                }
                
                // Attach theme toggle handler
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                loadAndGenerateCV();
                // Apply page settings after CV is loaded
                setTimeout(() => {
                    applyPageSettings();
                }, 100);
            });
            
            // Load page settings from localStorage
            function loadPageSettings() {
                try {
                    const cvDataJson = localStorage.getItem('cvData');
                    let margin = [12, 5, 12, 5]; // default: [top, right, bottom, left] - range 0-20
                    let paperSize = 'letter';
                    let orientation = 'portrait';
                    
                    if (cvDataJson) {
                        const data = JSON.parse(cvDataJson);
                        if (data.margin && Array.isArray(data.margin) && data.margin.length === 4) {
                            // Ensure all margins are between 0 and 20
                            margin = [
                                Math.max(0, Math.min(20, parseFloat(data.margin[0]) || 12)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[1]) || 5)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[2]) || 12)),
                                Math.max(0, Math.min(20, parseFloat(data.margin[3]) || 5))
                            ];
                        }
                        if (data.paperSize) {
                            paperSize = data.paperSize;
                        }
                        if (data.orientation) {
                            orientation = data.orientation;
                        }
                    }
                    
                    // Set input values
                    const topMarginInput = document.getElementById('topMargin');
                    const rightMarginInput = document.getElementById('rightMargin');
                    const bottomMarginInput = document.getElementById('bottomMargin');
                    const leftMarginInput = document.getElementById('leftMargin');
                    const paperSizeSelect = document.getElementById('paperSize');
                    const orientationSelect = document.getElementById('orientation');
                    
                    if (topMarginInput) topMarginInput.value = margin[0];
                    if (rightMarginInput) rightMarginInput.value = margin[1];
                    if (bottomMarginInput) bottomMarginInput.value = margin[2];
                    if (leftMarginInput) leftMarginInput.value = margin[3];
                    if (paperSizeSelect) paperSizeSelect.value = paperSize;
                    if (orientationSelect) orientationSelect.value = orientation;
                    
                    // Apply all settings to preview
                    applyPageSettings();
                } catch (e) {
                    console.warn('Could not load page settings:', e);
                }
            }

        // Paper size dimensions in mm (width x height for portrait)
        const paperDimensions = {
            'letter': { width: 215.9, height: 279.4 },
            'a4': { width: 210, height: 297 },
            'legal': { width: 215.9, height: 355.6 }
        };

        // Apply paper size and orientation to CV container (for preview)
        function applyPaperSizeAndOrientation(paperSize, orientation) {
            const cvContainer = document.getElementById('cvContainer');
            if (!cvContainer) return;

            const dimensions = paperDimensions[paperSize] || paperDimensions['letter'];
            let width, height;

            if (orientation === 'landscape') {
                width = dimensions.height;
                height = dimensions.width;
            } else {
                width = dimensions.width;
                height = dimensions.height;
            }

            // Convert mm to pixels (1mm ≈ 3.779527559 pixels at 96 DPI)
            const mmToPx = 3.779527559;
            const widthPx = width * mmToPx;
            const heightPx = height * mmToPx;

            // Apply dimensions to preview
            cvContainer.style.width = widthPx + 'px';
            cvContainer.style.minWidth = widthPx + 'px';
            cvContainer.style.maxWidth = widthPx + 'px';
            cvContainer.style.minHeight = heightPx + 'px';
            
            // For print, use mm units
            cvContainer.style.setProperty('--print-width', width + 'mm');
            cvContainer.style.setProperty('--print-height', height + 'mm');
        }

        // Apply margins to CV container (for preview)
        function applyMargins(margin) {
            const cvContainer = document.getElementById('cvContainer');
            if (cvContainer && margin && margin.length === 4) {
                cvContainer.style.marginTop = margin[0] + 'mm';
                cvContainer.style.marginRight = margin[1] + 'mm';
                cvContainer.style.marginBottom = margin[2] + 'mm';
                cvContainer.style.marginLeft = margin[3] + 'mm';
            }
        }

        // Apply all page settings to preview
        function applyPageSettings() {
            try {
                const cvDataJson = localStorage.getItem('cvData');
                let margin = [12, 5, 12, 5];
                let paperSize = 'letter';
                let orientation = 'portrait';
                
                if (cvDataJson) {
                    const data = JSON.parse(cvDataJson);
                    if (data.margin && Array.isArray(data.margin) && data.margin.length === 4) {
                        margin = [
                            Math.max(0, Math.min(20, parseFloat(data.margin[0]) || 12)),
                            Math.max(0, Math.min(20, parseFloat(data.margin[1]) || 5)),
                            Math.max(0, Math.min(20, parseFloat(data.margin[2]) || 12)),
                            Math.max(0, Math.min(20, parseFloat(data.margin[3]) || 5))
                        ];
                    }
                    if (data.paperSize) {
                        paperSize = data.paperSize;
                    }
                    if (data.orientation) {
                        orientation = data.orientation;
                    }
                }
                
                // Apply paper size and orientation
                applyPaperSizeAndOrientation(paperSize, orientation);
                
                // Apply margins
                applyMargins(margin);
            } catch (e) {
                console.warn('Could not apply page settings:', e);
            }
        }

        // Update margin
        function updateMargin(side, value) {
            const numValue = parseFloat(value) || 0;
            const input = document.getElementById(side + 'Margin');
            if (input) {
                // Ensure value is between 0 and 20
                if (numValue < 0) {
                    input.value = 0;
                } else if (numValue > 20) {
                    input.value = 20;
                }
            }
            savePageSettings();
            // Immediately apply to preview
            applyPageSettings();
        }

        // Update paper size
        function updatePaperSize(value) {
            savePageSettings();
            // Immediately apply to preview
            applyPageSettings();
        }

        // Update orientation
        function updateOrientation(value) {
            savePageSettings();
            // Immediately apply to preview
            applyPageSettings();
        }

            // Save page settings to localStorage
            function savePageSettings() {
                try {
                    const cvDataJson = localStorage.getItem('cvData');
                    if (cvDataJson) {
                        const data = JSON.parse(cvDataJson);
                        
                        // Get margin values and ensure they are between 0 and 20
                        const topMargin = Math.max(0, Math.min(20, parseFloat(document.getElementById('topMargin').value) || 12));
                        const rightMargin = Math.max(0, Math.min(20, parseFloat(document.getElementById('rightMargin').value) || 5));
                        const bottomMargin = Math.max(0, Math.min(20, parseFloat(document.getElementById('bottomMargin').value) || 12));
                        const leftMargin = Math.max(0, Math.min(20, parseFloat(document.getElementById('leftMargin').value) || 5));
                        
                        // Update input values if they were out of range
                        document.getElementById('topMargin').value = topMargin;
                        document.getElementById('rightMargin').value = rightMargin;
                        document.getElementById('bottomMargin').value = bottomMargin;
                        document.getElementById('leftMargin').value = leftMargin;
                        
                        data.margin = [topMargin, rightMargin, bottomMargin, leftMargin];
                        data.paperSize = document.getElementById('paperSize').value || 'letter';
                        data.orientation = document.getElementById('orientation').value || 'portrait';
                        
                        localStorage.setItem('cvData', JSON.stringify(data));
                    }
                } catch (e) {
                    console.warn('Could not save page settings:', e);
                }
            }
        </script>
        <script>
            // Drawer functionality
            let drawerOpen = false;
            
            function toggleDrawer() {
                const drawer = document.getElementById('leftDrawer');
                const drawerToggle = document.getElementById('drawerToggle');
                const drawerToggleText = document.getElementById('drawerToggleText');
                const toggleIcon = document.getElementById('drawerToggleIcon');
                const mainContent = document.getElementById('mainContent');
                const drawerItems = document.querySelectorAll('.drawer-item-content');
                
                drawerOpen = !drawerOpen;
                
                if (drawerOpen) {
                    drawer.classList.remove('drawer-closed');
                    drawer.classList.add('drawer-open');
                    drawerToggleText.style.opacity = '0';
                    drawerToggleText.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        drawerToggleText.classList.add('hidden');
                    }, 150);
                    drawerToggle.style.width = '80px';
                    drawerToggle.style.height = '80px';
                    drawerToggle.style.right = '-48px';
                    toggleIcon.style.width = '48px';
                    toggleIcon.style.height = '48px';
                    if (mainContent) {
                        mainContent.style.marginLeft = '280px';
                    }
                    drawerItems.forEach(item => {
                        item.classList.remove('hidden');
                    });
                } else {
                    drawer.classList.remove('drawer-open');
                    drawer.classList.add('drawer-closed');
                    drawerToggleText.classList.remove('hidden');
                    setTimeout(() => {
                        drawerToggleText.style.opacity = '1';
                        drawerToggleText.style.transform = 'scale(1)';
                    }, 10);
                    drawerToggle.style.width = '120px';
                    drawerToggle.style.height = '120px';
                    drawerToggle.style.right = '-145px';
                    toggleIcon.style.width = '50px';
                    toggleIcon.style.height = '50px';
                    if (mainContent) {
                        mainContent.style.marginLeft = '0px';
                    }
                    drawerItems.forEach(item => {
                        item.classList.add('hidden');
                    });
                }
            }
            
            // Image Modal functions
            function openImageModal() {
                const modal = document.getElementById('imageModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.zIndex = '9999';
                    modal.classList.add('flex');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeImageModal(event) {
                const modal = document.getElementById('imageModal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.style.zIndex = '0';
                    modal.classList.remove('flex');
                    document.body.style.overflow = '';
                }
            }
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
            
            // Initialize drawer state
            document.addEventListener('DOMContentLoaded', function() {
                const drawer = document.getElementById('leftDrawer');
                const mainContent = document.getElementById('mainContent');
                const drawerItems = document.querySelectorAll('.drawer-item-content');
                
                if (drawer && mainContent) {
                    drawer.classList.add('drawer-closed');
                    mainContent.style.marginLeft = '0px';
                    mainContent.style.transition = 'margin-left 0.3s ease-in-out';
                    if (drawerItems.length > 0) {
                        drawerItems.forEach(item => {
                            item.classList.add('hidden');
                        });
                    }
                }
            });
        </script>
    </body>
</html>


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CV - LuxSleek Template</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        borderRadius: {
                            lg: 'var(--radius)',
                            md: 'calc(var(--radius) - 2px)',
                            sm: 'calc(var(--radius) - 4px)'
                        }
                    }
                }
            }
        </script>
        <!-- html2pdf library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <style>
            /* Base font for entire document */
            body, #cvContainer, #cvContainer * {
                font-family: Calibri, Arial, sans-serif !important;
            }
            
            :root {
                --radius: 0.65rem;
                --background: 0 0% 100%;
                --foreground: 0 0% 3.9%;
                --card: 0 0% 100%;
                --card-foreground: 0 0% 3.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 0 0% 3.9%;
                --primary: 0 0% 9%;
                --primary-foreground: 0 0% 98%;
                --secondary: 0 0% 96.1%;
                --secondary-foreground: 0 0% 9%;
                --muted: 0 0% 96.1%;
                --muted-foreground: 0 0% 45.1%;
                --accent: 0 0% 96.1%;
                --accent-foreground: 0 0% 9%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 0 0% 98%;
                --border: 0 0% 89.8%;
                --input: 0 0% 89.8%;
                --ring: 0 0% 3.9%;
                --chart-1: 12 76% 61%;
                --chart-2: 173 58% 39%;
                --chart-3: 197 37% 24%;
                --chart-4: 43 74% 66%;
                --chart-5: 27 87% 67%;
                --luxsleek-blue: 220 40% 28%;
            }

            .dark {
                --background: 0 0% 3.9%;
                --foreground: 0 0% 98%;
                --card: 0 0% 9%;
                --card-foreground: 0 0% 98%;
                --popover: 0 0% 9%;
                --popover-foreground: 0 0% 98%;
                --primary: 0 0% 89.8%;
                --primary-foreground: 0 0% 9%;
                --secondary: 0 0% 14.9%;
                --secondary-foreground: 0 0% 98%;
                --muted: 0 0% 14.9%;
                --muted-foreground: 0 0% 63.9%;
                --accent: 0 0% 14.9%;
                --accent-foreground: 0 0% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 0 0% 98%;
                --border: 0 0% 100% / 0.1;
                --input: 0 0% 100% / 0.15;
                --ring: 0 0% 45.1%;
                --chart-1: 220 70% 50%;
                --chart-2: 160 60% 45%;
                --chart-3: 30 80% 55%;
                --chart-4: 280 65% 60%;
                --chart-5: 340 75% 55%;
                --sidebar: 0 0% 9%;
                --sidebar-foreground: 0 0% 98%;
                --sidebar-primary: 220 70% 50%;
                --sidebar-primary-foreground: 0 0% 98%;
                --sidebar-accent: 0 0% 14.9%;
                --sidebar-accent-foreground: 0 0% 98%;
                --sidebar-border: 0 0% 100% / 0.1;
                --sidebar-ring: 0 0% 45.1%;
            }

            /* shadcn/ui color utilities for Tailwind v3 */
            .bg-background { background-color: hsl(var(--background)); }
            .bg-card { background-color: hsl(var(--card)); }
            .bg-popover { background-color: hsl(var(--popover)); }
            .bg-primary { background-color: hsl(var(--primary)); }
            .bg-secondary { background-color: hsl(var(--secondary)); }
            .bg-muted { background-color: hsl(var(--muted)); }
            .bg-accent { background-color: hsl(var(--accent)); }
            .bg-destructive { background-color: hsl(var(--destructive)); }
            
            .text-foreground { color: hsl(var(--foreground)); }
            .text-card-foreground { color: hsl(var(--card-foreground)); }
            .text-popover-foreground { color: hsl(var(--popover-foreground)); }
            .text-primary-foreground { color: hsl(var(--primary-foreground)); }
            .text-secondary-foreground { color: hsl(var(--secondary-foreground)); }
            .text-muted-foreground { color: hsl(var(--muted-foreground)); }
            .text-accent-foreground { color: hsl(var(--accent-foreground)); }
            .text-destructive-foreground { color: hsl(var(--destructive-foreground)); }
            
            .border-border { border-color: hsl(var(--border)); }
            .border-input { border-color: hsl(var(--input)); }
            .border-ring { border-color: hsl(var(--ring)); }
            
            /* LuxSleek specific colors */
            .bg-luxsleek-blue { background-color: hsl(var(--luxsleek-blue)); }
            .text-luxsleek-blue { color: hsl(var(--luxsleek-blue)); }
            
            /* Opacity variants */
            .bg-primary\/90 { background-color: hsl(var(--primary) / 0.9); }
            .bg-secondary\/80 { background-color: hsl(var(--secondary) / 0.8); }
            .bg-muted\/50 { background-color: hsl(var(--muted) / 0.5); }
            .bg-accent\/50 { background-color: hsl(var(--accent) / 0.5); }
            .bg-destructive\/90 { background-color: hsl(var(--destructive) / 0.9); }
            
            .hover\:bg-primary\/90:hover { background-color: hsl(var(--primary) / 0.9); }
            .hover\:bg-secondary\/80:hover { background-color: hsl(var(--secondary) / 0.8); }
        </style>
    </head>
    <body class="bg-background text-foreground min-h-screen print:bg-white print:p-0 print:m-0">
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-4 md:p-6 print:p-0 print:m-0 print:bg-white">
            <div
                class="max-w-4xl mx-auto bg-card rounded-lg shadow-sm print:max-w-none print:shadow-none print:rounded-none print:m-0">
                <!-- Fixed Action Buttons at Top -->
                <div class="sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border print:hidden">
                    <div class="p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl md:text-2xl font-bold tracking-tight">Your CV</h1>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                                <button onclick="downloadPDF(event)" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-primary text-primary-foreground hover:bg-primary/90 h-9 rounded-md gap-1.5 px-4 shadow-sm border-0 cursor-pointer flex-1 sm:flex-none">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download PDF
                                </button>
                                <button onclick="goBack()" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 rounded-md gap-1.5 px-4 shadow-sm border-0 cursor-pointer flex-1 sm:flex-none">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                    Back to Edit
                                </button>
                                <button id="themeToggle" type="button" class="inline-flex items-center justify-center text-sm font-medium transition-colors bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 w-9 rounded-md shadow-sm border-0 cursor-pointer" aria-label="Toggle theme" title="Toggle light/dark theme">
                                    <svg id="sunIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    <svg id="moonIcon" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CV Container -->
                <div class="flex justify-center items-start px-4 py-6 print:p-0 print:m-0">
                    <div
                        id="cvContainer" class="cv-preview bg-card text-foreground rounded-lg shadow-lg p-6 md:p-8 print:shadow-none print:rounded-none print:p-0 print:m-0 print:bg-white print:w-full print:max-w-full print:min-h-[792px] print:text-black print:mx-0" style="margin: 0 auto; padding: 24px;">
                        <!-- CV content will be generated here -->
                        <div id="loadingMessage" class="text-center py-8">
                            <p class="text-muted-foreground">Loading CV...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../script.js"></script>
        <script>
            // Load CV data from localStorage and generate CV
            async function loadAndGenerateCV() {
                try {
                    // Get data from localStorage
                    const cvDataJson = localStorage.getItem('cvData');

                    if (!cvDataJson) {
                        document.getElementById('cvContainer').innerHTML = '<div class="text-center py-8"><p class="text-destructive">No CV data found. Please go back and fill out the form.</p><button onclick="goBack()" class="mt-4 inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 rounded-md gap-1.5 px-4">Go Back</button></div>';
                        return;
                    }

                    const data = JSON.parse(cvDataJson);
                    const template = data.template || 'luxsleek';
                    const cvContainer = document.getElementById('cvContainer');

                    // Hide loading message
                    document.getElementById('loadingMessage').style.display = 'none';

                    // Generate CV directly using inline generation
                    const html = generateCVFromData(data);
                    cvContainer.innerHTML = html;

                } catch (error) {
                    console.error('Error loading CV:', error);
                    document.getElementById('cvContainer').innerHTML = '<div class="text-center py-8"><p class="text-destructive">Error loading CV: ' + error.message + '</p><button onclick="goBack()" class="mt-4 inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 rounded-md gap-1.5 px-4">Go Back</button></div>';
                }
            }

            // Download CV as PDF using html2pdf
            async function downloadPDF(event) {
                const cvContainer = document.getElementById('cvContainer');
                if (!cvContainer) {
                    alert('CV container not found');
                    return;
                }

                // Get the name from localStorage data for filename
                let filename = 'cv.pdf';
                try {
                    const cvDataJson = localStorage.getItem('cvData');
                    if (cvDataJson) {
                        const data = JSON.parse(cvDataJson);
                        if (data.name) {
                            filename = data.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_cv.pdf';
                        }
                    }
                } catch (e) {
                    console.warn('Could not get name from localStorage:', e);
                }

                // Configure html2pdf options
                const options = {
                    margin: [0, 0, 0, 0],
                    filename: filename,
                    image: {
                        type: 'jpeg',
                        quality: 0.98
                    },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        logging: false,
                        width: cvContainer.scrollWidth,
                        height: cvContainer.scrollHeight,
                        windowWidth: cvContainer.scrollWidth,
                        windowHeight: cvContainer.scrollHeight,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        removeContainer: false,
                        onclone: function(clonedDoc) {
                            // Ensure left column is visible in cloned document
                            const clonedLeftCol = clonedDoc.querySelector('#luxsleek-left-column');
                            if (clonedLeftCol) {
                                clonedLeftCol.style.display = 'table-cell';
                                clonedLeftCol.style.visibility = 'visible';
                                clonedLeftCol.style.opacity = '1';
                                clonedLeftCol.style.width = '33%';
                                clonedLeftCol.style.backgroundColor = '#304263';
                                clonedLeftCol.style.background = '#304263';
                                clonedLeftCol.style.color = 'white';
                            }
                        }
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'letter',
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: {
                        mode: ['avoid-all', 'css', 'legacy']
                    }
                };

                // Get button reference
                const button = event ? event.target.closest('button') : document.querySelector('button[onclick="downloadPDF()"]');
                const originalText = button ? button.innerHTML : '';

                try {
                    // Show loading state
                    if (button) {
                        button.disabled = true;
                        button.innerHTML = '<span>‚è≥</span> Generating PDF...';
                    }

                    // Force HSL colors for html2pdf compatibility and fix layout
                    const colorFixStyle = document.createElement('style');
                    colorFixStyle.id = 'pdf-color-fix';
                    colorFixStyle.textContent = `
                        :root, #cvContainer, #cvContainer * {
                            --background: hsl(0 0% 100%) !important;
                            --foreground: hsl(0 0% 3.9%) !important;
                            --card: hsl(0 0% 100%) !important;
                            --card-foreground: hsl(0 0% 3.9%) !important;
                            --primary: hsl(0 0% 9%) !important;
                            --primary-foreground: hsl(0 0% 98%) !important;
                            --secondary: hsl(0 0% 96.1%) !important;
                            --secondary-foreground: hsl(0 0% 9%) !important;
                            --muted: hsl(0 0% 96.1%) !important;
                            --muted-foreground: hsl(0 0% 45.1%) !important;
                            --accent: hsl(0 0% 96.1%) !important;
                            --accent-foreground: hsl(0 0% 9%) !important;
                            --destructive: hsl(0 84.2% 60.2%) !important;
                            --destructive-foreground: hsl(0 0% 98%) !important;
                            --border: hsl(0 0% 89.8%) !important;
                            --input: hsl(0 0% 89.8%) !important;
                            --ring: hsl(0 0% 3.9%) !important;
                            --luxsleek-blue: 220 40% 28% !important;
                        }
                        #cvContainer {
                            background: white !important;
                            color: black !important;
                            margin: 0 !important;
                            padding: 0 !important;
                            width: 100% !important;
                            max-width: 100% !important;
                            overflow: visible !important;
                            position: relative !important;
                        }
                        /* Table layout for better PDF compatibility */
                        #cvContainer > div,
                        #luxsleek-wrapper,
                        #cvContainer #luxsleek-wrapper,
                        #cvContainer > div#luxsleek-wrapper {
                            margin: 0 !important;
                            padding: 0 !important;
                            width: 100% !important;
                            display: table !important;
                            table-layout: fixed !important;
                            min-height: 100vh !important;
                            overflow: visible !important;
                            position: relative !important;
                            font-family: Calibri, Arial, sans-serif !important;
                            font-size: 12px !important;
                            border-collapse: collapse !important;
                        }
                        /* Table row wrapper */
                        #luxsleek-wrapper > div,
                        #cvContainer #luxsleek-wrapper > div {
                            display: table-row !important;
                        }
                        /* Left column - table cell */
                        *[id="luxsleek-left-column"],
                        *[id*="luxsleek-left"],
                        #luxsleek-left-column,
                        #cvContainer #luxsleek-left-column,
                        #cvContainer > div > div#luxsleek-left-column,
                        #cvContainer > div #luxsleek-left-column,
                        div#luxsleek-left-column {
                            width: 33% !important;
                            display: table-cell !important;
                            vertical-align: top !important;
                            background-color: #304263 !important;
                            background: #304263 !important;
                            color: white !important;
                            min-height: 100vh !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            font-family: Calibri, Arial, sans-serif !important;
                            font-size: 12px !important;
                        }
                        /* Right column - table cell */
                        #luxsleek-right-column,
                        #cvContainer #luxsleek-right-column,
                        #cvContainer > div > div#luxsleek-right-column,
                        #cvContainer > div #luxsleek-right-column,
                        div#luxsleek-right-column {
                            width: 67% !important;
                            display: table-cell !important;
                            vertical-align: top !important;
                            background-color: white !important;
                            color: black !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            font-family: Calibri, Arial, sans-serif !important;
                            font-size: 12px !important;
                        }
                        /* Fallback for any div with width 33% */
                        #cvContainer > div > div[style*="width: 33%"],
                        #cvContainer > div > div[style*="width: 33%"] {
                            width: 33% !important;
                            display: table-cell !important;
                            vertical-align: top !important;
                            background-color: #304263 !important;
                            color: white !important;
                            min-height: 100vh !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            font-family: Calibri, Arial, sans-serif !important;
                            font-size: 12px !important;
                            position: relative !important;
                        }
                        /* Fallback for any div with width 67% */
                        #cvContainer > div > div[style*="width: 67%"],
                        #cvContainer > div > div[style*="width: 67%"] {
                            display: table-cell !important;
                            vertical-align: top !important;
                            background-color: white !important;
                            color: black !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            font-family: Calibri, Arial, sans-serif !important;
                            font-size: 12px !important;
                        }
                        #cvContainer * {
                            color: inherit !important;
                        }
                        #cvContainer > div > div[style*="width: 33%"] * {
                            color: white !important;
                        }
                        #cvContainer > div > div[style*="width: 67%"] * {
                            color: black !important;
                        }
                        #cvContainer a {
                            color: inherit !important;
                        }
                    `;
                    document.head.appendChild(colorFixStyle);

                    // Wait for styles to apply and ensure layout is rendered
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Force multiple reflows to ensure html2canvas sees the layout
                    cvContainer.offsetHeight;
                    const leftCol = cvContainer.querySelector('#luxsleek-left-column');
                    const rightCol = cvContainer.querySelector('#luxsleek-right-column');
                    const wrapper = cvContainer.querySelector('#luxsleek-wrapper');
                    
                    if (leftCol) {
                        // Ensure left column is visible and properly styled
                        leftCol.style.display = 'table-cell';
                        leftCol.style.visibility = 'visible';
                        leftCol.style.opacity = '1';
                        leftCol.style.width = '33%';
                        leftCol.style.backgroundColor = '#304263';
                        leftCol.style.background = '#304263';
                        leftCol.style.color = 'white';
                        leftCol.style.minHeight = '100vh';
                        leftCol.offsetHeight; // Force reflow
                    }
                    
                    if (rightCol) {
                        rightCol.style.display = 'table-cell';
                        rightCol.style.visibility = 'visible';
                        rightCol.style.opacity = '1';
                        rightCol.style.width = '67%';
                        rightCol.offsetHeight; // Force reflow
                    }
                    
                    if (wrapper) {
                        wrapper.style.display = 'table';
                        wrapper.style.tableLayout = 'fixed';
                        wrapper.style.width = '100%';
                        wrapper.offsetHeight; // Force reflow
                    }
                    
                    // Additional wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Generate and download PDF
                    await html2pdf().set(options).from(cvContainer).save();

                    // Remove color fix after PDF generation
                    if (colorFixStyle.parentNode) {
                        colorFixStyle.parentNode.removeChild(colorFixStyle);
                    }

                    // Restore button
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');

                    // Remove color fix if it exists
                    const colorFixStyle = document.getElementById('pdf-color-fix');
                    if (colorFixStyle && colorFixStyle.parentNode) {
                        colorFixStyle.parentNode.removeChild(colorFixStyle);
                    }

                    // Restore button
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                }
            }

            // Go back to form
            function goBack() {
                window.location.href = '../index.html';
            }

            // Theme switching functionality
            function initTheme() {
                const themeToggle = document.getElementById('themeToggle');
                const sunIcon = document.getElementById('sunIcon');
                const moonIcon = document.getElementById('moonIcon');
                const html = document.documentElement;

                if (!themeToggle || !sunIcon || !moonIcon) {
                    console.warn('Theme toggle elements not found');
                    return;
                }

                // Get saved theme or default to light
                const savedTheme = localStorage.getItem('theme') || 'light';

                // Apply saved theme on page load
                function applyTheme(theme) {
                    if (theme === 'dark') {
                        html.classList.add('dark');
                        sunIcon.classList.add('hidden');
                        moonIcon.classList.remove('hidden');
                    } else {
                        html.classList.remove('dark');
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    }
                }

                // Initialize theme
                applyTheme(savedTheme);

                // Toggle theme on button click
                themeToggle.addEventListener('click', () => {
                    const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    applyTheme(newTheme);
                    localStorage.setItem('theme', newTheme);
                });
            }

            // Load CV when page loads
            document.addEventListener('DOMContentLoaded', function () {
                initTheme();
                loadAndGenerateCV();
            });
        </script>
    </body>
</html>

